<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>slot 处理过程</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/myvue/assets/css/styles.0ed13fd6.css" as="style"><link rel="preload" href="/myvue/assets/js/app.0ed13fd6.js" as="script"><link rel="preload" href="/myvue/assets/js/13.5642dc66.js" as="script"><link rel="prefetch" href="/myvue/assets/js/4.291f75a5.js"><link rel="prefetch" href="/myvue/assets/css/1.styles.609f56ce.css"><link rel="prefetch" href="/myvue/assets/js/1.609f56ce.js"><link rel="prefetch" href="/myvue/assets/css/2.styles.85337e5e.css"><link rel="prefetch" href="/myvue/assets/js/2.85337e5e.js"><link rel="prefetch" href="/myvue/assets/js/3.73a61e2b.js"><link rel="prefetch" href="/myvue/assets/js/5.418053be.js"><link rel="prefetch" href="/myvue/assets/js/6.3985446b.js"><link rel="prefetch" href="/myvue/assets/js/7.60a7156d.js"><link rel="prefetch" href="/myvue/assets/js/8.8bf40752.js"><link rel="prefetch" href="/myvue/assets/js/9.f2786eb3.js"><link rel="prefetch" href="/myvue/assets/js/10.656d0ee4.js"><link rel="prefetch" href="/myvue/assets/js/11.db2bcfb9.js"><link rel="prefetch" href="/myvue/assets/js/12.1faa0bf6.js">
    <link rel="stylesheet" href="/myvue/assets/css/styles.0ed13fd6.css"><link rel="stylesheet" href="/myvue/assets/css/1.styles.609f56ce.css"><link rel="stylesheet" href="/myvue/assets/css/2.styles.85337e5e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myvue/" class="home-link router-link-active"></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myvue/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/myvue/config/" class="nav-link">配置参考</a></div><div class="nav-item"><a href="/myvue/default-theme-config/" class="nav-link">默认主题配置</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myvue/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/myvue/config/" class="nav-link">配置参考</a></div><div class="nav-item"><a href="/myvue/default-theme-config/" class="nav-link">默认主题配置</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/myvue/默认slot.html" class="active sidebar-link">slot 处理过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myvue/默认slot.html#总体概述" class="sidebar-link">总体概述</a></li><li class="sidebar-sub-header"><a href="/myvue/默认slot.html#使用范例" class="sidebar-link">使用范例</a></li><li class="sidebar-sub-header"><a href="/myvue/默认slot.html#模板编译、生成code、生成-vnode" class="sidebar-link">模板编译、生成code、生成 vnode</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myvue/默认slot.html#patch阶段" class="sidebar-link">patch阶段</a></li><li class="sidebar-sub-header"><a href="/myvue/默认slot.html#outer组件实例的创建过程" class="sidebar-link">outer组件实例的创建过程</a></li></ul></li></ul></li><li><a href="/myvue/组件patch阶段.html" class="sidebar-link">patch阶段组件处理相关逻辑</a></li><li><a href="/myvue/props.html" class="sidebar-link">props</a></li><li><a href="/myvue/attrs.html" class="sidebar-link">$attrs</a></li><li><a href="/myvue/patch.html" class="sidebar-link">Patch</a></li><li><a href="/myvue/listeners.html" class="sidebar-link">listeners</a></li><li><a href="/myvue/ref.html" class="sidebar-link">$ref</a></li><li><a href="/myvue/functional component.html" class="sidebar-link">函数式组件</a></li><li><a href="/myvue/update component.html" class="sidebar-link">组件更新解析</a></li><li><a href="/myvue/computed.html" class="sidebar-link">计算属性</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="slot-处理过程"><a href="#slot-处理过程" aria-hidden="true" class="header-anchor">#</a> slot 处理过程</h1> <h2 id="总体概述"><a href="#总体概述" aria-hidden="true" class="header-anchor">#</a> 总体概述</h2> <p>每一个vue实例，最终渲染到页面上都要经历如下几个阶段</p> <ol><li>编译模板生成code，即render函数</li> <li>执行render函数生成 vnode</li> <li>patch 阶段，对比新旧vnode，生成新的html。</li></ol> <h2 id="使用范例"><a href="#使用范例" aria-hidden="true" class="header-anchor">#</a> 使用范例</h2> <p><a href="https://jsfiddle.net/chenlihu118/zLg8xauo/15/" target="_blank" rel="noopener noreferrer">地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">makeOption</span> <span class="token operator">=</span> name <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">,</span>
    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`&lt;div&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/div&gt;`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
        &lt;div&gt;
          &lt;outer&gt;&lt;span&gt;{{msg}}&lt;/span&gt;&lt;/outer&gt;
        &lt;/div&gt;
      `</span></span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">:</span> <span class="token string">'outer'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    components<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        outer<span class="token punctuation">:</span> <span class="token function">makeOption</span><span class="token punctuation">(</span><span class="token string">'outer'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>生成的html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>outer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>outer 是一个组件，vue 允许组件模板定义中使用插槽 slot。插槽的内容由组件的使用者灵活指定。</p> <p>如上面的例子中: outer 组件插槽的内容被指定成了模板</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{msg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>注意一下上述模板的作用域为父组件</p> <h2 id="模板编译、生成code、生成-vnode"><a href="#模板编译、生成code、生成-vnode" aria-hidden="true" class="header-anchor">#</a> 模板编译、生成code、生成 vnode</h2> <p>模板</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>outer</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{msg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>outer</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>对应的render函数如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'outer'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>_v 对应 createTextVnode,生成 text vnode 的时候，msg 以被求值。作用域就是this。</p> <p>_c 对应 createElement (vdom/create-element.js)生成 vnode。</p> <p>_c('outer',……) 的时候，因为 outer 为组件，所以会调用 createComponent (vdom/create-component.js) 生成组件 vnode</p> <p>createComponent 主要逻辑</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span> <span class="token punctuation">(</span>
  Ctor<span class="token punctuation">,</span>
  data<span class="token punctuation">,</span>
  context<span class="token punctuation">,</span>
  children<span class="token punctuation">,</span>
  tag
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生成构造函数</span>
  <span class="token keyword">const</span> baseCtor <span class="token operator">=</span> context<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_base
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Ctor <span class="token operator">=</span> baseCtor<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// install component management hooks onto the placeholder node</span>
  <span class="token comment">/*
     实现比较简单，
     在 data.hook 上保存一些 patch 阶段会用到的钩子函数
     componentVNodeHooks 保存了一些内置的钩子
     下面的函数，会安装内置的钩子。如果发现已经定义过了，则通过一个新函数合并他们
  */</span>
  <span class="token function">installComponentHooks</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  
  <span class="token comment">/*
  	对于组件它的 children 保存在了 componentOptions 上
  	还有 Ctor 等
  */</span>
  <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token string">`vue-component-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Ctor<span class="token punctuation">.</span>cid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name <span class="token operator">?</span> `<span class="token operator">-</span>$<span class="token punctuation">{</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">}</span>`<span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
    undefined<span class="token punctuation">,</span>
    undefined<span class="token punctuation">,</span>
    undefined<span class="token punctuation">,</span>
    context<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> Ctor<span class="token punctuation">,</span> propsData<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token punctuation">,</span>
    asyncFactory
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的分析，执行完render函数，vnode就正常生成了。其中我们也阐述了，组件vnode和普通vnode的不同。vnode生成了，下一步就该进行 update 了，即 patch 阶段。</p> <h3 id="patch阶段"><a href="#patch阶段" aria-hidden="true" class="header-anchor">#</a> patch阶段</h3> <p>因为此时没有 oldVnode，所以主要是通过调用 createElm 生成vnode对应的真正的 html</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// empty mount (likely as component), create new root element</span>
        <span class="token comment">// 对于组件mount的时候，在 options 中没有指定 el,在调用 $mount 的时候，也没有指定。</span>
        <span class="token comment">// 所以这里的 oldVnode 为空</span>
        <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为本文主要在解析 slot，所以我们只关注相关的部分。如果碰到一个组件vnode，则直接调用 createComponent 为组件vnode生成html</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createElm</span> <span class="token punctuation">(</span>
    vnode<span class="token punctuation">,</span>
    insertedVnodeQueue<span class="token punctuation">,</span>
    parentElm<span class="token punctuation">,</span>
    refElm<span class="token punctuation">,</span>
    nested<span class="token punctuation">,</span>
    ownerArray<span class="token punctuation">,</span>
    index
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">createComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>我们发现 createComponent 并没有直接创建组件html，而是调用 init 钩子</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createComponent</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">let</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*hydrating*/</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
         <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token boolean">true</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>init钩子中主要干了点什么呢？我们知道一个组件，其实就是一个新的vue实例。我们只需要实例化一个新的vue实例并mount它就可以了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">init</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里需要注意一点 child.$mount 会生成 $el 这里的HTML是在 vnode.componentInstance</span>
    <span class="token comment">// 上，并没有为 vnode.elm 赋值。</span>
    <span class="token comment">// 在 patch 阶段中 createElm 为 vnode生成 elm .对于组件会调用 patch.js 中的</span>
    <span class="token comment">// createComment 生成 elm</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> <span class="token function">createComponentInstanceForVnode</span><span class="token punctuation">(</span>
      vnode<span class="token punctuation">,</span>
      activeInstance
    <span class="token punctuation">)</span>
    child<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>hydrating <span class="token operator">?</span> vnode<span class="token punctuation">.</span>elm <span class="token punctuation">:</span> undefined<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponentInstanceForVnode</span><span class="token punctuation">(</span>
  vnode<span class="token punctuation">,</span>
  parent
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    _isComponent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    _parentVnode<span class="token punctuation">:</span> vnode<span class="token punctuation">,</span>
    parent
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">vnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">.</span>Ctor</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来我们主要分析一下，outer组件实例的创建过程</p> <h3 id="outer组件实例的创建过程"><a href="#outer组件实例的创建过程" aria-hidden="true" class="header-anchor">#</a> outer组件实例的创建过程</h3> <h5 id="init-阶段"><a href="#init-阶段" aria-hidden="true" class="header-anchor">#</a> init 阶段</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/*
        这里其实也是合并 options。对于组件采用下面的这种方式，而没有采用 mergeOptions
        是因为 initInternalComponent 更高效
      */</span>
      <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token comment">// 这里只关注 children。这里的 children 就是上面实例化组件 vnode 时传入的</span>
<span class="token comment">// &lt;outer&gt;这里元素对应的vnode&lt;/outer&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initInternalComponent</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> vnodeComponentOptions <span class="token operator">=</span> parentVnode<span class="token punctuation">.</span>componentOptions
  opts<span class="token punctuation">.</span>_renderChildren <span class="token operator">=</span> vnodeComponentOptions<span class="token punctuation">.</span>children
<span class="token punctuation">}</span>
</code></pre></div><p>关于这个children，我们下面有用。</p> <p>解析生成 vm.$slots</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initRender</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>$slots <span class="token operator">=</span> <span class="token function">resolveSlots</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>_renderChildren<span class="token punctuation">,</span> renderContext<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveSlots</span> <span class="token punctuation">(</span> children<span class="token punctuation">,</span> context <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> slots <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>slots<span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">||</span> <span class="token punctuation">(</span>slots<span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> slots
<span class="token punctuation">}</span>

</code></pre></div><h5 id="render-函数"><a href="#render-函数" aria-hidden="true" class="header-anchor">#</a> render 函数</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_t</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>_t 就是 renderSlot , 对于当前例子删减后的主要逻辑, 可以理解成伪代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderSlot</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> fallback<span class="token punctuation">,</span> props<span class="token punctuation">,</span> bindObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> slotNodes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">[</span>name<span class="token punctuation">]</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>slotNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      slotNodes<span class="token punctuation">.</span>_rendered <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">return</span>  nodes <span class="token operator">=</span> slotNodes <span class="token operator">||</span> fallback
<span class="token punctuation">}</span>

</code></pre></div><p>到这里成功把 componentOptions.children 替换了插槽。接下来的执行逻辑雷同，不再继续分析了。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/myvue/assets/js/13.5642dc66.js" defer></script><script src="/myvue/assets/js/app.0ed13fd6.js" defer></script>
  </body>
</html>
